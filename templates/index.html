<!doctype html>
<html lang="en">
<head>
    <title>Dynamic Query Builder with Visualization</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>Dynamic Query Builder Engine</h1>

    <h3>Available Fields:</h3>
    <ul>
        {% for attr in attributes %}
            <li>{{ attr }}</li>
        {% endfor %}
    </ul>

    <form method="POST">
        <h4>Select Fields:</h4>
        {% for attr in attributes %}
            <input type="checkbox" name="fields" value="{{ attr }}"> {{ attr }}<br>
        {% endfor %}

        <h4>Filter Options:</h4>
        <label>Region:</label>
        <select name="region">
            <option value="">-- Any Region --</option>
            {% for r in regions %}
                <option value="{{ r }}">{{ r }}</option>
            {% endfor %}
        </select><br><br>

        <label>Date Range:</label>
        <span>Available: {{ min_date }} to {{ max_date }}</span><br>
        <input type="date" name="start_date" min="{{ min_date }}" max="{{ max_date }}">
        to
        <input type="date" name="end_date" min="{{ min_date }}" max="{{ max_date }}"><br><br>

        <h4>Aggregate Function (on 'amount'):</h4>
        <select name="aggregate">
            <option value="">None</option>
            <option value="sum">Sum</option>
            <option value="avg">Average</option>
            <option value="count">Count</option>
        </select><br><br>

        <h4>Sorting:</h4>
        <label>Sort By:</label>
        <select name="sort_field">
            <option value="">-- No Sorting --</option>
            {% for attr in attributes %}
                <option value="{{ attr }}">{{ attr }}</option>
            {% endfor %}
        </select>
        <select name="sort_order">
            <option value="asc">Ascending</option>
            <option value="desc">Descending</option>
        </select><br><br>

        <label><input type="checkbox" name="distinct"> Remove Duplicate Rows</label><br><br>

        <h4>Select Graph Type:</h4>
        <select name="graph_type">
            {% for gtype in graph_types %}
                <option value="{{ gtype }}">{{ gtype }}</option>
            {% endfor %}
        </select><br><br>

        <button type="submit">Generate Report & Visualize</button>
    </form>

    {% if report_data %}
        <h2>Report Results:</h2>
        <table border="1">
            <tr>
                {% for key in report_data[0].keys() %}
                    <th>{{ key }}</th>
                {% endfor %}
            </tr>
            {% for row in report_data %}
                <tr>
                    {% for value in row.values() %}
                        <td>{{ value }}</td>
                    {% endfor %}
                </tr>
            {% endfor %}
        </table>
    {% endif %}

    {% if chart_data %}
        <h2>Visualization: {{ chart_data.graph_type }}</h2>
        <canvas id="reportChart" width="400" height="200"></canvas>
        <script>
            const ctx = document.getElementById('reportChart').getContext('2d');
            const chartTypeMap = {
                'Bar Chart': 'bar',
                'Line Chart': 'line',
                'Pie Chart': 'pie',
                'Scatter Plot': 'scatter'
            };
            const chartType = chartTypeMap["{{ chart_data.graph_type }}"] || 'bar';
            new Chart(ctx, {
                type: chartType,
                data: {
                    labels: {{ chart_data.labels | tojson }},
                    datasets: [{
                        label: "{{ chart_data.label }}",
                        data: {{ chart_data.values | tojson }},
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true
                }
            });
        </script>
    {% endif %}
</body>
</html>
